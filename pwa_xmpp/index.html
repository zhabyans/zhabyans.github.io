<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - MyApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/strophe.js@3.1.1/dist/strophe.umd.min.js"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png">
</head>

<body class="min-h-screen flex items-center justify-center bg-gray-100">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 mx-2">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Masuk ke Akun</h1>
      <p class="text-gray-500 text-sm mt-2">Silakan login untuk melanjutkan</p>
    </div>

    <form id="loginForm" class="space-y-5">
      <div>
        <label class="block text-gray-700 mb-2" for="username">Username</label>
        <input type="text" id="username"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          placeholder="contoh: user1" required />
      </div>

      <div>
        <label class="block text-gray-700 mb-2" for="password">Kata Sandi</label>
        <input type="password" id="password"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
      </div>

      <button type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition duration-200">
        Masuk
      </button>
    </form>

    <p class="text-center text-sm text-gray-600 mt-6">
      Belum punya akun?
      <a href="#" class="text-blue-600 hover:underline">Daftar sekarang</a>
    </p>
  </div>

  <script>
    const ws_url = "wss://pulsa.dpdns.org:7443/ws";
    const defaultDomain = "pulsa.dpdns.org";

    // Jika sudah login, langsung ke home
    if (localStorage.getItem("isLoggedIn") === "true") {
      window.location.href = "home.html";
    }

    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!username || !password) {
        alert("Silakan isi username dan kata sandi!");
        return;
      }

      // Jika user tidak menulis domain, tambahkan otomatis
      const jid = username.includes("@") ? username : `${username}@${defaultDomain}`;

      const conn = new Strophe.Connection(ws_url);
      conn.connect(jid + "/", password, (status) => {
        switch (status) {
          case Strophe.Status.CONNECTED:
            console.log("âœ… Terhubung ke server XMPP sebagai:", conn.jid);
            localStorage.setItem("isLoggedIn", "true");
            localStorage.setItem("userEmail", jid);

            // Kirim presence agar muncul online
            conn.send($pres().c("priority").t("127"));
            console.log("ðŸŸ¢ Presence dikirim, user muncul online");

            // Simpan koneksi global agar tetap hidup
            window.globalConn = conn;

            // Arahkan ke home
            window.location.href = "home.html";
            break;
          case Strophe.Status.AUTHFAIL:
            alert("âŒ Login gagal, periksa username & password!");
            break;
          case Strophe.Status.CONNFAIL:
            alert("âš ï¸ Gagal terhubung ke server.");
            break;
        }
      });
    });

    // Daftarkan Service Worker untuk PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log("âœ… Service Worker terdaftar."))
        .catch(err => console.error("SW error:", err));
    }
  </script>
</body>
</html>
